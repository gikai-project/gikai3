import streamlit as st
from openai import OpenAI
import json

# ======================================================
# Streamlit 基本設定
# ======================================================
st.set_page_config(
    page_title="一般質問 採点AIシステム（300点モデル）",
    layout="wide"
)

# ======================================================
# OpenAI API Key（Secrets 固定）
# ======================================================
if "OPENAI_API_KEY" not in st.secrets:
    st.error("OpenAI API Key が設定されていません（Secrets）")
    st.stop()

API_KEY = st.secrets["OPENAI_API_KEY"]
MAX_CALLS = int(st.secrets.get("MAX_CALLS", 100))

client = OpenAI(api_key=API_KEY)

# ======================================================
# API使用回数カウンタ
# ======================================================
if "api_calls" not in st.session_state:
    st.session_state.api_calls = 0

def check_api_limit():
    if st.session_state.api_calls >= MAX_CALLS:
        st.error(
            f"⚠ API利用上限に達しました（{MAX_CALLS}回）。管理者に連絡してください。"
        )
        st.stop()

# ======================================================
# 評価項目名（15項目）
# ======================================================
ITEM_NAMES = {
    "1": "テーマ設定の妥当性",
    "2": "目的の明確性",
    "3": "論理構成の明確性",
    "4": "根拠・エビデンスの妥当性",
    "5": "質問の具体性",
    "6": "政策提案の実現可能性",
    "7": "行政答弁を引き出す質問力",
    "8": "議会の役割・法的理解",
    "9": "住民視点・説明責任の明瞭性",
    "10": "答弁後のフォロー可能性",
    "11": "文章表現・スピーチ技術",
    "12": "行政との協働姿勢・倫理性",
    "13": "将来志向・イノベーション性",
    "14": "政策横断性・全体視点",
    "15": "議員としての成長・継続性"
}

# ======================================================
# ランク判定（300点）
# ======================================================
def judge_rank(total: int) -> str:
    if total >= 270:
        return "S（極めて完成度が高い）"
    if total >= 240:
        return "A（非常に質が高い）"
    if total >= 210:
        return "B（水準以上）"
    if total >= 180:
        return "C（最低限成立）"
    if total >= 150:
        return "D（再設計推奨）"
    return "E（不十分）"

# ======================================================
# AI 採点プロンプト（研究向け・理由文対応）
# ======================================================
def build_prompt(text: str) -> str:
    return f"""
あなたは地方議会の一般質問を評価する専門家です。
以下の【評価観点】に厳密に基づいて採点してください。

【重要ルール】
・評価は必ず各項目の定義文のみを根拠に行う
・迷った場合は必ず低い点を付ける
・主観的好意評価は禁止
・評価不能な場合は0点
・採点理由は点数と必ず整合させること

【採点方式】
・15項目
・各項目20点満点（A〜Dの合計）
・合計300点
・A〜Dは各0〜5点
・3点＝最低限、5点＝例外的に優れている場合のみ

【採点理由】
・各項目ごとに50〜100字
・評価観点に即して具体的に述べる
・抽象的表現や感想は禁止

【評価観点】
1. テーマ設定の妥当性：
地域課題としての重要性・緊急性が明確であり、議会で扱う合理性が示されているか。
2. 目的の明確性：
質問を通じて何を明らかにしたいのか、到達点が具体的に示されているか。
3. 論理構成の明確性：
問題提起→理由→質問の流れが論理的に整理され、飛躍や混乱がないか。
4. 根拠・エビデンスの妥当性：
統計・事例・制度など、事実に基づく根拠が適切に用いられているか。
5. 質問の具体性：
抽象論に終始せず、行政が具体的に答弁できる水準まで落とし込まれているか。
6. 政策提案の実現可能性：
制度・財政・人員等を踏まえ、現実的に検討可能な提案になっているか。
7. 行政答弁を引き出す質問力：
Yes/Noで逃げられず、行政の見解や判断を引き出す構造になっているか。
8. 議会の役割・法的理解：
地方議会の権限・役割や関係法令を踏まえた質問になっているか。
9. 住民視点・説明責任の明瞭性：
住民の立場に立ち、なぜこの質問が必要かが説明できているか。
10. 答弁後のフォロー可能性：
再質問・要望・政策反映など、その後の展開が想定できるか。
11. 文章表現・スピーチ技術：
文章が明確で聞き取りやすく、誤解を生まない表現になっているか。
12. 行政との協働姿勢・倫理性：
対立や攻撃を目的とせず、建設的な政策改善を意図しているか。
13. 将来志向・イノベーション性：
中長期的視点や新しい発想が含まれているか。
14. 政策横断性・全体視点：
単一分野に閉じず、関連政策との関係が意識されているか。
15. 議員としての成長・継続性：
継続的な問題意識や調査姿勢が読み取れるか。

【評価対象文章】
{text}

【出力形式（JSONのみ・説明文禁止）】
{{
 "scores": {{
   "1": {{"A":0,"B":0,"C":0,"D":0,"reason":""}},
   "2": {{"A":0,"B":0,"C":0,"D":0,"reason":""}},
   "3": {{"A":0,"B":0,"C":0,"D":0,"reason":""}},
   "4": {{"A":0,"B":0,"C":0,"D":0,"reason":""}},
   "5": {{"A":0,"B":0,"C":0,"D":0,"reason":""}},
   "6": {{"A":0,"B":0,"C":0,"D":0,"reason":""}},
   "7": {{"A":0,"B":0,"C":0,"D":0,"reason":""}},
   "8": {{"A":0,"B":0,"C":0,"D":0,"reason":""}},
   "9": {{"A":0,"B":0,"C":0,"D":0,"reason":""}},
   "10": {{"A":0,"B":0,"C":0,"D":0,"reason":""}},
   "11": {{"A":0,"B":0,"C":0,"D":0,"reason":""}},
   "12": {{"A":0,"B":0,"C":0,"D":0,"reason":""}},
   "13": {{"A":0,"B":0,"C":0,"D":0,"reason":""}},
   "14": {{"A":0,"B":0,"C":0,"D":0,"reason":""}},
   "15": {{"A":0,"B":0,"C":0,"D":0,"reason":""}}
 }}
}}
""".strip()

# ======================================================
# UI
# ======================================================
st.title("📘 一般質問 採点AIシステム（300点モデル）")
st.caption(f"API利用状況：{st.session_state.api_calls} / {MAX_CALLS} 回")

question_text = st.text_area("▼ 一般質問の原稿", height=280)

if st.button("🚀 AIで自動採点"):
    check_api_limit()

    if not question_text.strip():
        st.error("文章が入力されていません。")
        st.stop()

    with st.spinner("AIが採点中…"):
        response = client.responses.create(
            model="gpt-4.1",
            input=build_prompt(question_text)
        )
        st.session_state.api_calls += 1

        raw = response.output_text

        try:
            json_str = raw[raw.find("{"):raw.rfind("}") + 1]
            data = json.loads(json_str)
        except Exception:
            st.error("AIの出力形式が不正です。再実行してください。")
            st.stop()

        scores = data["scores"]

        total = 0
        item_totals = {}
        for i in range(1, 16):
            s = scores[str(i)]
            subtotal = s["A"] + s["B"] + s["C"] + s["D"]
            item_totals[str(i)] = subtotal
            total += subtotal

    st.success("採点完了")

    for i in range(1, 16):
        with st.expander(
            f"{i}. {ITEM_NAMES[str(i)]}（{item_totals[str(i)]} / 20点）"
        ):
            for k in ["A", "B", "C", "D"]:
                st.write(f"{k}：{scores[str(i)][k]}点")
            st.write(f"📝 採点理由：{scores[str(i)]['reason']}")

    st.subheader(f"🔢 合計点：{total} / 300")
    st.subheader(f"🏆 ランク：{judge_rank(total)}")
