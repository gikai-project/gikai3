import streamlit as st
from openai import OpenAI
import json
import plotly.graph_objects as go

# ======================================================
# Streamlit åŸºæœ¬è¨­å®š
# ======================================================
st.set_page_config(
    page_title="ä¸€èˆ¬è³ªå• æ¡ç‚¹AIã‚·ã‚¹ãƒ†ãƒ ï¼ˆ300ç‚¹ãƒ¢ãƒ‡ãƒ«ï¼‰",
    layout="wide"
)

# ======================================================
# API ã‚­ãƒ¼å…¥åŠ›ï¼ˆã‚µã‚¤ãƒ‰ãƒãƒ¼ï¼‰
# ======================================================
st.sidebar.header("ğŸ”‘ OpenAI API Key")
api_key = st.sidebar.text_input(
    "APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆsk- ã§å§‹ã¾ã‚‹ã‚­ãƒ¼ï¼‰",
    type="password"
)

client = None
if api_key:
    client = OpenAI(api_key=api_key)

# ======================================================
# è©•ä¾¡é …ç›®åï¼ˆ15é …ç›®ï¼‰
# ======================================================
ITEM_NAMES = {
    "1": "ãƒ†ãƒ¼ãƒè¨­å®šã®å¦¥å½“æ€§",
    "2": "ç›®çš„ã®æ˜ç¢ºæ€§",
    "3": "è«–ç†æ§‹æˆã®æ˜ç¢ºæ€§",
    "4": "æ ¹æ‹ ãƒ»ã‚¨ãƒ“ãƒ‡ãƒ³ã‚¹ã®å¦¥å½“æ€§",
    "5": "è³ªå•ã®å…·ä½“æ€§",
    "6": "æ”¿ç­–ææ¡ˆã®å®Ÿç¾å¯èƒ½æ€§",
    "7": "è¡Œæ”¿ç­”å¼ã‚’å¼•ãå‡ºã™è³ªå•åŠ›",
    "8": "è­°ä¼šã®å½¹å‰²ãƒ»æ³•çš„ç†è§£",
    "9": "ä½æ°‘è¦–ç‚¹ãƒ»èª¬æ˜è²¬ä»»ã®æ˜ç­æ€§",
    "10": "ç­”å¼å¾Œã®ãƒ•ã‚©ãƒ­ãƒ¼å¯èƒ½æ€§",
    "11": "æ–‡ç« è¡¨ç¾ãƒ»ã‚¹ãƒ”ãƒ¼ãƒæŠ€è¡“",
    "12": "è¡Œæ”¿ã¨ã®å”åƒå§¿å‹¢ãƒ»å€«ç†æ€§",
    "13": "å°†æ¥å¿—å‘ãƒ»ã‚¤ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³æ€§",
    "14": "æ”¿ç­–æ¨ªæ–­æ€§ãƒ»å…¨ä½“è¦–ç‚¹",
    "15": "è­°å“¡ã¨ã—ã¦ã®æˆé•·ãƒ»ç¶™ç¶šæ€§"
}

# ======================================================
# ãƒ©ãƒ³ã‚¯åˆ¤å®šï¼ˆ300ç‚¹ï¼‰
# ======================================================
def judge_rank(total: int) -> str:
    if total >= 270:
        return "Sï¼ˆæ¥µã‚ã¦å®Œæˆåº¦ãŒé«˜ã„ï¼‰"
    if total >= 240:
        return "Aï¼ˆéå¸¸ã«è³ªãŒé«˜ã„ï¼‰"
    if total >= 210:
        return "Bï¼ˆæ°´æº–ä»¥ä¸Šï¼‰"
    if total >= 180:
        return "Cï¼ˆæœ€ä½é™æˆç«‹ï¼‰"
    if total >= 150:
        return "Dï¼ˆå†è¨­è¨ˆæ¨å¥¨ï¼‰"
    return "Eï¼ˆä¸ååˆ†ï¼‰"

# ======================================================
# Aã€œDåˆ¥ãƒ¬ãƒ¼ãƒ€ãƒ¼ãƒãƒ£ãƒ¼ãƒˆ
# ======================================================
def show_axis_radar(scores, axis):
    labels = [ITEM_NAMES[str(i)] for i in range(1, 16)]
    values = [scores[str(i)][axis] for i in range(1, 16)]

    fig = go.Figure()
    fig.add_trace(go.Scatterpolar(
        r=values + [values[0]],
        theta=labels + [labels[0]],
        fill="toself"
    ))
    fig.update_layout(
        polar=dict(radialaxis=dict(range=[0, 5])),
        showlegend=False,
        title=f"{axis} è©•ä¾¡ï¼ˆ15é …ç›®ï¼‰"
    )
    st.plotly_chart(fig, use_container_width=True)

# ======================================================
# AI æ¡ç‚¹ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼ˆ15é …ç›®Ã—20ç‚¹ï¼‰
# ======================================================
def build_prompt(text: str) -> str:
    return f"""
ã‚ãªãŸã¯åœ°æ–¹è­°ä¼šã®ä¸€èˆ¬è³ªå•ã‚’è©•ä¾¡ã™ã‚‹å°‚é–€å®¶ã§ã™ã€‚

ã€æ¡ç‚¹æ–¹å¼ã€‘
ãƒ»è©•ä¾¡é …ç›®ï¼š15
ãƒ»å„é …ç›®ã¯ Aã€œD ã®4è¦³ç‚¹
ãƒ»å„è¦³ç‚¹ 0ã€œ5ç‚¹ï¼ˆæ•´æ•°ï¼‰
ãƒ»1é …ç›®ã‚ãŸã‚Šæœ€å¤§20ç‚¹
ãƒ»3ç‚¹ã¯æœ€ä½é™ã€5ç‚¹ã¯ä¾‹å¤–çš„æ°´æº–
ãƒ»è¿·ã£ãŸå ´åˆã¯å¿…ãšä½ã„ç‚¹ã‚’ä»˜ã‘ã‚‹
ãƒ»è©•ä¾¡ä¸èƒ½ãªå ´åˆã¯0ç‚¹

ã€è©•ä¾¡è¦³ç‚¹ã€‘
Aï¼šæ ¸å¿ƒé©åˆãƒ»æœ¬è³ªæ€§
Bï¼šæ˜ç¢ºæ€§ãƒ»å…·ä½“æ€§
Cï¼šæ ¹æ‹ ãƒ»è£ä»˜ã‘
Dï¼šè­°ä¼šãƒ»è¡Œæ”¿é©åˆæ€§

ã€è©•ä¾¡å¯¾è±¡æ–‡ç« ã€‘
{text}

ã€å‡ºåŠ›å½¢å¼ï¼ˆJSONã®ã¿ï¼‰ã€‘
{{
 "scores": {{
   "1": {{"A":0,"B":0,"C":0,"D":0}},
   "2": {{"A":0,"B":0,"C":0,"D":0}},
   "3": {{"A":0,"B":0,"C":0,"D":0}},
   "4": {{"A":0,"B":0,"C":0,"D":0}},
   "5": {{"A":0,"B":0,"C":0,"D":0}},
   "6": {{"A":0,"B":0,"C":0,"D":0}},
   "7": {{"A":0,"B":0,"C":0,"D":0}},
   "8": {{"A":0,"B":0,"C":0,"D":0}},
   "9": {{"A":0,"B":0,"C":0,"D":0}},
   "10": {{"A":0,"B":0,"C":0,"D":0}},
   "11": {{"A":0,"B":0,"C":0,"D":0}},
   "12": {{"A":0,"B":0,"C":0,"D":0}},
   "13": {{"A":0,"B":0,"C":0,"D":0}},
   "14": {{"A":0,"B":0,"C":0,"D":0}},
   "15": {{"A":0,"B":0,"C":0,"D":0}}
 }},
 "comments": {{
   "1": {{"A":"ç†ç”±","B":"ç†ç”±","C":"ç†ç”±","D":"ç†ç”±"}},
   "2": {{"A":"ç†ç”±","B":"ç†ç”±","C":"ç†ç”±","D":"ç†ç”±"}},
   "3": {{"A":"ç†ç”±","B":"ç†ç”±","C":"ç†ç”±","D":"ç†ç”±"}},
   "4": {{"A":"ç†ç”±","B":"ç†ç”±","C":"ç†ç”±","D":"ç†ç”±"}},
   "5": {{"A":"ç†ç”±","B":"ç†ç”±","C":"ç†ç”±","D":"ç†ç”±"}},
   "6": {{"A":"ç†ç”±","B":"ç†ç”±","C":"ç†ç”±","D":"ç†ç”±"}},
   "7": {{"A":"ç†ç”±","B":"ç†ç”±","C":"ç†ç”±","D":"ç†ç”±"}},
   "8": {{"A":"ç†ç”±","B":"ç†ç”±","C":"ç†ç”±","D":"ç†ç”±"}},
   "9": {{"A":"ç†ç”±","B":"ç†ç”±","C":"ç†ç”±","D":"ç†ç”±"}},
   "10": {{"A":"ç†ç”±","B":"ç†ç”±","C":"ç†ç”±","D":"ç†ç”±"}},
   "11": {{"A":"ç†ç”±","B":"ç†ç”±","C":"ç†ç”±","D":"ç†ç”±"}},
   "12": {{"A":"ç†ç”±","B":"ç†ç”±","C":"ç†ç”±","D":"ç†ç”±"}},
   "13": {{"A":"ç†ç”±","B":"ç†ç”±","C":"ç†ç”±","D":"ç†ç”±"}},
   "14": {{"A":"ç†ç”±","B":"ç†ç”±","C":"ç†ç”±","D":"ç†ç”±"}},
   "15": {{"A":"ç†ç”±","B":"ç†ç”±","C":"ç†ç”±","D":"ç†ç”±"}}
 }}
}}
""".strip()

# ======================================================
# ãƒ¡ã‚¤ãƒ³UI
# ======================================================
st.title("ğŸ“˜ ä¸€èˆ¬è³ªå• æ¡ç‚¹AIã‚·ã‚¹ãƒ†ãƒ ï¼ˆ15é …ç›®Ã—20ç‚¹ï¼300ç‚¹ï¼‰")
st.markdown("å„é …ç›® Aã€œDï¼ˆå„0ã€œ5ç‚¹ï¼‰ã§ **300ç‚¹æº€ç‚¹** ã®å³æ ¼è©•ä¾¡ã‚’è¡Œã„ã¾ã™ã€‚")

question_text = st.text_area(
    "â–¼ ä¸€èˆ¬è³ªå•ã®åŸç¨¿ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„",
    height=280
)

if st.button("ğŸš€ AIã§è‡ªå‹•æ¡ç‚¹ã™ã‚‹"):
    if not api_key:
        st.error("APIã‚­ãƒ¼ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚")
    elif not question_text.strip():
        st.error("æ–‡ç« ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚")
    else:
        with st.spinner("AIãŒæ¡ç‚¹ä¸­â€¦"):
            try:
                response = client.chat.completions.create(
                    model="gpt-4.1",
                    messages=[{"role": "user", "content": build_prompt(question_text)}]
                )

                raw = response.choices[0].message.content
                data = json.loads(raw[raw.find("{"):raw.rfind("}") + 1])

                scores = data["scores"]
                comments = data["comments"]

                total = 0
                item_totals = {}

                for i in range(1, 16):
                    s = scores[str(i)]
                    subtotal = s["A"] + s["B"] + s["C"] + s["D"]
                    item_totals[str(i)] = subtotal
                    total += subtotal

            except Exception as e:
                st.error("AIã®å¿œç­”ã‚’è§£æã§ãã¾ã›ã‚“ã§ã—ãŸã€‚")
                st.code(str(e))
            else:
                st.success("æ¡ç‚¹å®Œäº†ï¼")

                for i in range(1, 16):
                    with st.expander(
                        f"{i}. {ITEM_NAMES[str(i)]}ï¼ˆ{item_totals[str(i)]} / 20ç‚¹ï¼‰"
                    ):
                        for k in ["A", "B", "C", "D"]:
                            st.markdown(f"**{k}ï¼š{scores[str(i)][k]}ç‚¹**")
                            st.write(comments[str(i)][k])

                st.markdown("---")
                st.subheader(f"ğŸ”¢ åˆè¨ˆç‚¹ï¼š**{total} / 300 ç‚¹**")
                st.subheader(f"ğŸ† ãƒ©ãƒ³ã‚¯ï¼š**{judge_rank(total)}**")

                axis_label = st.radio(
                    "ğŸ“Š è¡¨ç¤ºã™ã‚‹è©•ä¾¡è»¸",
                    ["Aï¼ˆæ ¸å¿ƒé©åˆï¼‰", "Bï¼ˆæ˜ç¢ºæ€§ï¼‰", "Cï¼ˆæ ¹æ‹ ï¼‰", "Dï¼ˆè­°ä¼šé©åˆï¼‰"]
                )

                show_axis_radar(scores, axis_label[0])
